---
import { pbGET } from "@/services/pocketbase";
import Layout from "@/layouts/Layout.astro";

const pbToken = Astro.cookies.get('pbToken')?.value
const cookieParams = new URLSearchParams(pbToken);
const userId = cookieParams.get("user");

const currentUser = await pbGET(
  `/api/collections/users/records/${userId}`, {}, pbToken,
).then((res) => res.data);

const users = await pbGET(
  "/api/collections/users/records", {}, pbToken,
).then((res) => res.data.items.toSorted((a: any, b: any) => ((b.points - a.points) || (a.username.localeCompare(b.username)))));

---

<Layout title="Leaderboard">
  <h1>Leaderboard</h1>

<center>
    <table class="min-w-64">
      <thead>
        <tr>
          <th class="text-left">Name</th>
          <th>Points</th>
        </tr>
      </thead>
      <tbody>
        {users.map((user: any, index: number) => (
          <tr class={user.id === currentUser.id ? "text-purple-400 bg-slate-900 font-bold" : ""}>
            <td title={user.email}>{user.username} {(index === 0 && user.points > 0) && '🏆'}</td>
            <td class="text-center">{user.points}</td>
          </tr>
        ))}
      </tbody>
    </table>
</center>

	<div class="w-full">
		<div class="text-2xl">Group Phase Stats</div>
			<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-5 lg:gap-8 px-5 lg:px-8">
			</div>
		</div>
	</div>
  </div>

  <!-- <pre>{JSON.stringify({currentUser, users}, null, 2)}</pre> -->
</Layout>